pipeline {

    agent any

    parameters {
        string(name: 'BRANCH', defaultValue: 'develop', description: 'Rama Git a utilizar')
        choice(name: 'ENVIRONMENT', choices: ['desa', 'certi', 'prod'], description: 'Ambiente de despliegue')
        string(name: 'VERSION', defaultValue: '', description: 'Versi√≥n certificada (obligatorio para PROD)')
    }

    environment {
        APP_NAME   = "redeban-api-bonos-bpo"

        // YAML placeholders
        PLACEHOLDER_NAMESPACE   = "NAMESPACE"
        PLACEHOLDER_APP_NAME    = "APP_NAME"
        PLACEHOLDER_APP_CONTEXT = "APP_CONTEXT"
        PLACEHOLDER_VERSION     = "VERSION"
        PLACEHOLDER_REGISTRY    = "REGISTRY"
        PLACEHOLDER_REGPULL     = "REGISTRY_PULL"
        PLACEHOLDER_ROUTE_HOST  = "ROUTE_HOST"
    }

    stages {

        /* ===========================================================
                         CHECKOUT DEL C√ìDIGO
           =========================================================== */
        stage('Checkout') {
            steps {
                script {
                    checkout([
                        $class: 'GitSCM',
                        branches: [[name: params.BRANCH]],
                        userRemoteConfigs: [[
                            url: env.GIT_URL,
                            credentialsId: env.GIT_CREDENTIALS
                        ]]
                    ])
                }
            }
        }

        /* ===========================================================
                       COMPILAR (solo desa/certi)
           =========================================================== */
        stage('Compile') {
            when { expression { params.ENVIRONMENT != 'prod' } }
            steps {
                sh "mvn clean package -DskipTests"
            }
        }

        /* ===========================================================
             CONSTRUIR IMAGEN (solo desa/certi)
           =========================================================== */
        stage('Build Image') {
            when { expression { params.ENVIRONMENT != 'prod' } }
            steps {
                script {
                    def registry = env["OCP_${params.ENVIRONMENT.toUpperCase()}_REGISTRY"]
                    sh """
                        docker build -t ${registry}/${APP_NAME}:${params.VERSION ?: "latest"} .
                    """
                }
            }
        }

        /* ===========================================================
                 HACER PUSH AL REGISTRY (solo desa/certi)
           =========================================================== */
        stage('Push Image') {
            when { expression { params.ENVIRONMENT != 'prod' } }
            steps {
                script {
                    def registry     = env["OCP_${params.ENVIRONMENT.toUpperCase()}_REGISTRY"]
                    def registryCred = env["OCP_${params.ENVIRONMENT.toUpperCase()}_REGCRED"]

                    withCredentials([usernamePassword(credentialsId: registryCred,
                        usernameVariable: 'REG_USR', passwordVariable: 'REG_PWD')]) {

                        sh """
                            echo "${REG_PWD}" | docker login ${registry} -u "${REG_USR}" --password-stdin
                            docker push ${registry}/${APP_NAME}:${params.VERSION ?: "latest"}
                        """
                    }
                }
            }
        }

        /* ===========================================================
                   PROMOVER IMAGEN CERTIFICADA A PRODUCCI√ìN
           =========================================================== */
        stage('Promote to PROD') {
            when { expression { params.ENVIRONMENT == 'prod' } }
            steps {
                script {
                    if (!params.VERSION?.trim()) {
                        error("ERROR: Para producci√≥n debe ingresar VERSION certificada.")
                    }

                    def regCerti = env["OCP_CERTI_REGISTRY"]
                    def regProd  = env["OCP_PROD_REGISTRY"]
                    def version  = params.VERSION

                    sh """
                        echo "üîç Validando que imagen certificada exista..."
                        docker manifest inspect ${regCerti}/${APP_NAME}:${version} || exit 1
                        
                        echo "‚¨á Descargando imagen certificada..."
                        docker pull ${regCerti}/${APP_NAME}:${version}

                        echo "üè∑ Promoviendo imagen a producci√≥n..."
                        docker tag  ${regCerti}/${APP_NAME}:${version}  ${regProd}/${APP_NAME}:${version}

                        echo "‚¨Ü Subiendo imagen a producci√≥n..."
                        docker push ${regProd}/${APP_NAME}:${version}
                    """
                }
            }
        }

        /* ===========================================================
            DESPLIEGUE OCP CON PLACEHOLDERS ESTILO PS1
           =========================================================== */
        stage('Deploy') {
            steps {
                script {
                    def api         = env["OCP_${params.ENVIRONMENT.toUpperCase()}_API"]
                    def registry    = env["OCP_${params.ENVIRONMENT.toUpperCase()}_REGISTRY"]
                    def registryPull = env["OCP_${params.ENVIRONMENT.toUpperCase()}_REGPULL"]
                    def cred        = env["OCP_${params.ENVIRONMENT.toUpperCase()}_CRED"]

                    withCredentials([usernamePassword(credentialsId: cred,
                        usernameVariable: 'USR', passwordVariable: 'PWD')]) {

                        sh """
                            oc login ${api} -u ${USR} -p ${PWD}
                            oc project ${APP_NAME}

                            for f in deploy/${params.ENVIRONMENT}/*.yaml; do
                                sed -e "s|__${PLACEHOLDER_APP_NAME}__|${APP_NAME}|g" \
                                    -e "s|__${PLACEHOLDER_VERSION}__|${params.VERSION ?: "latest"}|g" \
                                    -e "s|__${PLACEHOLDER_NAMESPACE}__|${APP_NAME}|g" \
                                    -e "s|__${PLACEHOLDER_REGISTRY}__|${registry}|g" \
                                    -e "s|__${PLACEHOLDER_REGPULL}__|${registryPull}|g" \
                                    "\$f" | oc apply -f -
                            done

                            oc rollout restart deployment/${APP_NAME}
                            oc rollout status deployment/${APP_NAME} --timeout=120s
                        """
                    }
                }
            }
        }
    }

    /* ===========================================================
              ROLLBACK AUTOM√ÅTICO ANTE FALLAS
       =========================================================== */
    post {
        failure {
            script {
                def api   = env["OCP_${params.ENVIRONMENT.toUpperCase()}_API"]
                def cred  = env["OCP_${params.ENVIRONMENT.toUpperCase()}_CRED"]

                withCredentials([usernamePassword(credentialsId: cred,
                    usernameVariable: 'USR', passwordVariable: 'PWD')]) {

                    sh """
                        echo "‚ö†Ô∏è Error detectado: ejecutando rollback (undeploy)"

                        oc login ${api} -u ${USR} -p ${PWD}
                        oc project ${APP_NAME}

                        oc delete deployment ${APP_NAME} --ignore-not-found
                        oc delete route ${APP_NAME} --ignore-not-found
                        oc delete service ${APP_NAME} --ignore-not-found
                        oc delete configmap ${APP_NAME} --ignore-not-found
                        oc delete secret ${APP_NAME} --ignore-not-found
                        oc delete hpa ${APP_NAME} --ignore-not-found
                    """
                }
            }
        }

        always {
            cleanWs()
        }
    }
}
